# Practice IVW MR - 21OCT25

Inverse variance weighted MR.

-   Exposure: Menarche timing - from a supplementary file.

-   Outcome: T2D GWAS - from Felix.

Equations for IVW

-   thetaUI = sum(bY\*bX1\*bYse\^-2/sum(bX1\^2\*bYse\^-2)

-   se_thetaUI = 1/sqrt(sum(bX1\^2bYse\^-2))

Definitions of the variables

-   bY: The associations of the genetic variants with the outcome.

-   bYse: Standard error of the associations of the genetic variants with the outcome.

-   bX1: The associations of the genetic variants with the risk factors are denoted bXk with standard error bXk se, where k = 1, ..., K.

Outcome File:

-   EA: effect allele

-   NEA: non-effect allele

```         
            SNP Chr       Pos EA NEA    EAF    Beta     SE  Pvalue   Neff
1   1:100000012   1 100000012  T   G 0.2500 -0.0260 0.0073 0.00040 231420
2    1:10000006   1  10000006  A   G 0.0047 -0.0380 0.0560 0.49000 225429
3   1:100000135   1 100000135  A   T 0.9900 -0.0330 0.0550 0.55000 226311
```

Exposure File:

-   ALLELE1: effect allele

-   ALLELE0: non-effect allele

```         
SNP          CHR       POS ALLELE1 ALLELE0 `Discovery MA` `European-only MA`  ...8    ...9  ...10
1 NA            NA        NA NA      NA      NA             ALLELE1 freq.       Beta    SE    P    
2 rs314265       6 105390567 T       C       European-only  0.6794              -0.125… 2.8E… 2.74…
3 rs11605693    11 122837037 T       C       European-only  0.44400000000000001 -5.589… 2.70… 2.78…
4 rs7852169      9 114318394 C       G       European-only  0.91369999999999996 -9.959… 4.79… 1.99…
```

Cleaning

-   The Exposure file needs cleaning. Selecting columns and creating new SNP IDs with chr number and position. Selecting only rows with positive betas - just make a new column for this. Flipping the ones with negative betas - make a new column for these as well. Creating new allele frequencies as well (1 - allele frequency) for the flipped alleles.

-   The Outcome file needs checking for harmonization.

Exposure file cleaning

```{r}
#install.packages("readxl")
```

```{r}
library(readxl)
library(tidyverse)

 exposure_raw <- readxl::read_excel("data/41588_2024_1798_MOESM4_ESM.xlsx", sheet = "ST2 | 1080 signals")

# Remove other ancestries and fix column names
exposure <- exposure_raw %>%
  dplyr::select(1:10) %>%
  rename_with(~ as.character(exposure_raw[1, .x]), .cols = 7:10) %>%
  slice(-1) %>%
  dplyr::filter(`Discovery MA` == 'European-only') %>%
  rename(rsid = SNP) %>%
  dplyr::mutate(SNP = paste(CHR, POS, sep = ":")) %>%
  dplyr::mutate(
    Beta = as.numeric(Beta),       
    Beta_positive = if_else(Beta > 0, Beta, NA_real_)
  ) %>%
  dplyr::mutate(Beta_negative = if_else(Beta < 0, Beta, NA_real_)) %>%
  dplyr::mutate(`ALLELE1 freq.` = as.numeric(`ALLELE1 freq.`))

neg_idx <- exposure$Beta < 0
exposure$Beta[neg_idx] <- -exposure$Beta[neg_idx]

# Step 3: Swap columns b and c for those rows
temp <- exposure$ALLELE1[neg_idx]
exposure$ALLELE1[neg_idx] <- exposure$ALLELE0[neg_idx]
exposure$ALLELE0[neg_idx] <- temp
exposure$`ALLELE1 freq.`[neg_idx] <- 1 - exposure$`ALLELE1 freq.`[neg_idx] 


write_tsv(exposure, "data/exposure_menarche_timing.tsv")
```

Reading the files

```{r}
exposure <- read.delim("data/exposure_menarche_timing.tsv", 
                      sep = "\t",
                      stringsAsFactors = FALSE)
outcome <- read.delim("data/Mahajan.NatGenet2018b.T2D.European.txt", 
                      sep = "\t",
                      stringsAsFactors = FALSE)
```

Preparing dfs for MR

```{r}

# Outcome
outcome_mr <- outcome %>%
  dplyr::select(SNP, EA, NEA, Beta, SE) %>%
  dplyr::rename(
    beta_outcome = Beta,
    se_outcome = SE,
    ea_outcome = EA,
    nea_outcome = NEA
  )

# Exposure
exposure_mr <- exposure %>%
  dplyr::select(SNP, ALLELE1, ALLELE0, Beta, SE) %>%
  dplyr::rename(
    beta_exposure = Beta,
    se_exposure = SE,
    ea_exposure = ALLELE1,
    nea_exposure = ALLELE0
  )
```

Merging - and harmonizing outcome alleles to exposure alleles

```{r}
merged1 <- inner_join(exposure_mr, outcome_mr, by = "SNP") #%>%
```

```{r}
check_harmonisation <- function(df) {
  df <- df %>%
    rowwise() %>%
    dplyr::mutate(
      alignment_status = case_when(
        # Alleles match directly
        ea_exposure == ea_outcome &
          nea_exposure == nea_outcome ~ "aligned",
        # Alleles are swapped
        ea_exposure == nea_outcome &
          nea_exposure == ea_outcome ~ "reverse",
        TRUE ~ "mismatch"
      )
    ) %>%
    ungroup()

  # Flip outcome effects where alleles are reversed 
  df <- df %>%
    dplyr::mutate(
      beta_outcome_harmonised = ifelse(alignment_status == "reverse", 
                                       -beta_outcome, 
                                       beta_outcome)
    )

  return(df)
}

harmonised_check <- check_harmonisation(merged1)
harmonised <- harmonised_check %>% dplyr::filter(alignment_status != "mismatch")

```

**The first formula in the document:**

Inverse variance weights (the inverse of the squared SE of the outcome)

```{r}
merged <- harmonised %>%
  dplyr::mutate(weight = 1 / (se_outcome^2))
```

IVW point estimate

```{r}
# IVW point estimate
theta_IVW <- sum(merged$beta_outcome_harmonised * merged$beta_exposure * merged$weight) /
             sum(merged$beta_exposure^2 * merged$weight)

exp_theta <- exp(theta_IVW)
print(exp_theta)

# IVW standard error
se_IVW <- 1 / sqrt(sum(merged$beta_exposure^2 * merged$weight))

# 95% Confidence Interval
CI_lower <- exp(theta_IVW - 1.96 * se_IVW)
CI_upper <- exp(theta_IVW + 1.96 * se_IVW)

# Print results
cat("IVW causal estimate (theta):", round(theta_IVW, 4), "\n")
cat("Standard error:", round(se_IVW, 4), "\n")
cat("95% CI:", round(CI_lower, 4), "to", round(CI_upper, 4), "\n")
```

Scatter plot

```{r}
# Scatter plot of SNP effects
ggplot(merged, aes(x = beta_exposure, y = beta_outcome_harmonised)) +
  geom_point(size = 2, color = "blue") +                       # SNP points
  geom_smooth(method = "lm", formula = y ~ x - 1,              # line through origin
              se = FALSE, color = "red", linetype = "dashed") +
  labs(
    title = "IVW MR: SNP-exposure vs SNP-outcome effects",
    x = "SNP - Exposure effect (beta)",
    y = "SNP - Outcome effect (beta)"
  ) +
  theme_minimal()
```

Measure of effect

**The second formula in the document (using linear regression):**

```{r}
# Weighted linear regression IVW MR
ivw_model <- lm(beta_outcome_harmonised ~ beta_exposure - 1,
                data = merged,
                weights = 1 / se_outcome^2)

# IVW causal estimate
thetaIVW <- summary(ivw_model)$coef[1]

# Fixed-effect SE
se_fixed <- summary(ivw_model)$coef[1,2] / summary(ivw_model)$sigma

# Multiplicative random-effect SE
se_random <- summary(ivw_model)$coef[1,2] / min(summary(ivw_model)$sigma, 1)

# Print results
cat("IVW estimate:", thetaIVW, "\n")
cat("SE fixed:", se_fixed)
cat("SE random:", se_random)

```

```{r}
ggplot(merged, aes(x = beta_exposure, y = beta_outcome_harmonised)) +
  geom_point(size = 2, color = "blue") +                              # SNP points
  geom_abline(slope = thetaIVW, intercept = 0, color = "red", linetype = "dashed", size = 1) +  # IVW line
  labs(
    title = "IVW MR: SNP-exposure vs SNP-outcome effects",
    subtitle = paste0("IVW estimate = ", round(thetaIVW, 3)),
    x = "SNP - Exposure effect (beta)",
    y = "SNP - Outcome effect (beta)"
  ) +
  theme_minimal()
```
