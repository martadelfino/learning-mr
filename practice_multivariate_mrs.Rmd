# Practice Multivariate IVW MR and MR Eggar - 27OCT25

Experiment:

-   Exposure: Menarche timing - from a supplementary file. <https://www.nature.com/articles/s41588-024-01798-4>

-   Exposure: BMI - I need to find this myself. <https://zenodo.org/records/1251813>

-   Outcome: T2D GWAS - from Felix.

#### Multivariate IVW MR notes

Notes:

-   The multivariable IVW method expands the IVW method using weighted linear regression by estimating the causal effects of the additional risk factors on the outcome.
-   In the equation below, I include an additional risk factor (and assume the causal estimate of interest is the effect of risk factor 1 on the outcome).
-   Either fixed- or multiplicative random-effects can be used to estimate the standard error of the causal effect.

Equations for Multivariate IVW MR.

``` r
theta1MI = summary(lm(bY~bX1+bX2+bX3-1, weights=bYse^-2))$coef[1]

se_theta1MI.fixed = summary(lm(bY~bX1+bX2+bX3-1, weights=bYse^-2))$coef[1,2]/
  summary(lm(bY~bX1+bX2+bX3-1, weights=bYse^-2))$sigma

se_theta1MI.random = summary(lm(bY~bX1+bX2+bX3-1, weights=bYse^-2))$coef[1,2]/
  min(summary(lm(bY~bX1+bX2+bX3-1, weights=bYse^-2))$sigma,1)
```

#### Multivariate MR Eggar notes

Notes:

-   The multivariable MR-Egger method is equivalent to the multivariable IVW method using weighted linear regression except the intercept is estimated rather than being set to zero.

-   Testing whether the intercept term is equal to zero is equivalent to testing for directional pleiotropy and the validity of the InSIDE assumption.

-   As with univariable MR-Egger, the standard errors should be calculated from the multiplicative random-effects model.

-   The genetic associations should be orientated with respect to the risk increasing or decreasing allele of the risk factor of interest.

-   In this sample code we will assume the causal effect of risk factor 1 is of primary interest.

-   Since the residual standard error is estimated for the multivariable MR-Egger model we use the t-distribution with J - (K + 1) degrees of freedom for inference.

Equations for Multivariate MR Eggar.

``` r
#Orientation of the genetic associations with respect to X1
clist<-c("bX2","bX3","bY")
for (var in clist){
  eval(parse(text=paste0(var,"<-ifelse(bX1>0,",var,",",var,"*-1)")))
}
bX1<-abs(bX1)

#Causal estimate for X1
theta1ME = summary(lm(bY~bX1+bX2+bX3, weights=bYse^-2))$coef[2]
se_theta1ME.random = summary(lm(bY~bX1+bX2+bX3, weights=bYse^-2))$coef[2,2]/
  min(summary(lm(bY~bX1+bX2+bX3, weights=bYse^-2))$sigma,1)
lb_theta1ME = theta1ME - qt(0.975,df=length(bX1)-4)*se_theta1ME.random
ub_theta1ME = theta1ME + qt(0.975,df=length(bX1)-4)*se_theta1ME.random
p_theta1ME = 2*(1-pt(abs(theta1ME/se_theta1ME.random),df=length(bX1)-4))

#Test for directional pleiotropy
interME = summary(lm(bY~bX1+bX2+bX3, weights=bYse^-2))$coef[1]
se_interME.random = summary(lm(bY~bX1+bX2+bX3, weights=bYse^-2))$coef[1,2]/
  min(summary(lm(bY~bX1+bX2+bX3, weights=bYse^-2))$sigma,1)
p_interME = 2*(1-pt(abs(interME/se_interME.random),df=length(bX1)-4))
```

To update:

Definitions of the variables

-   bY: The associations of the genetic variants with the outcome.

-   bYse: Standard error of the associations of the genetic variants with the outcome.

-   bX1: The associations of the genetic variants with the risk factors are denoted bXk with standard error bXk se, where k = 1, ..., K.

### Preparing files for MR

Cleaning

-   The Exposure file needs cleaning. Selecting columns and creating new SNP IDs with chr number and position. Selecting only rows with positive betas - just make a new column for this. Flipping the ones with negative betas - make a new column for these as well. Creating new allele frequencies as well (1 - allele frequency) for the flipped alleles.

```{r}
library(tidyverse, quietly = TRUE)
```

#### **Reading second exposure file - BMI**

```{r}
exposure_bmi <- read.table(gzfile("data/bmi.giant-ukbb.meta-analysis.combined.23May2018.txt.gz"), 
                           header = TRUE)
```

Cleaning

```{r}
exposure_bmi <- exposure_bmi %>%
  rename(rsid = SNP) %>%
  rename(Beta = BETA) %>%
  dplyr::mutate(SNP = paste(CHR, POS, sep = ":")) %>%
  dplyr::mutate(
    Beta = as.numeric(Beta),       
    Beta_positive = if_else(Beta > 0, Beta, NA_real_)
  ) %>%
  dplyr::mutate(Beta_negative = if_else(Beta < 0, Beta, NA_real_)) %>%
  dplyr::mutate(Freq_Tested_Allele = as.numeric(Freq_Tested_Allele))
```

```{r}
neg_idx <- exposure_bmi$Beta < 0
exposure_bmi$Beta[neg_idx] <- -exposure_bmi$Beta[neg_idx]

# Swap columns b and c for those rows
temp <- exposure_bmi$Tested_Allele[neg_idx]
exposure_bmi$Tested_Allele[neg_idx] <- exposure_bmi$Other_Allele[neg_idx]
exposure_bmi$Other_Allele[neg_idx] <- temp
exposure_bmi$Freq_Tested_Allele[neg_idx] <- 1 - exposure_bmi$Freq_Tested_Allele[neg_idx] 
```

#### Reading the other Exposure (menarche timing) and Outcome (T2D) files

```{r}
exposure_menarche <- read.delim("data/exposure_menarche_timing.tsv", 
                      sep = "\t",
                      stringsAsFactors = FALSE)
outcome_t2d <- read.delim("data/Mahajan.NatGenet2018b.T2D.European.txt", 
                      sep = "\t",
                      stringsAsFactors = FALSE)
```

Preparing dfs for MR

```{r}
# Outcome
outcome_t2d_mr <- outcome_t2d %>%
  dplyr::select(SNP, EA, NEA, Beta, SE) %>%
  dplyr::rename(
    beta_outcome = Beta,
    se_outcome = SE,
    ea_outcome = EA,
    nea_outcome = NEA
  )

# Exposure menarche
exposure_menarche_mr <- exposure_menarche %>%
  dplyr::select(SNP, ALLELE1, ALLELE0, Beta, SE) %>%
  dplyr::rename(
    beta_exposure_menarche = Beta,
    se_exposure_menarche = SE,
    ea_exposure_menarche = ALLELE1,
    nea_exposure_menarche = ALLELE0
  )

# Exposure BMI
exposure_bmi_mr <- exposure_bmi %>%
  dplyr::select(SNP, Tested_Allele, Other_Allele, Beta, SE) %>%
  dplyr::rename(
    beta_exposure_bmi = Beta,
    se_exposure_bmi = SE,
    ea_exposure_bmi = Tested_Allele,
    nea_exposure_bmi = Other_Allele
  )
```

Merging and harmonizing the exposures

```{r}
exposures_merged <- inner_join(exposure_menarche_mr, exposure_bmi_mr, by = "SNP")
```

```{r}
check_exposures_harmonisation <- function(df) {
  df <- df %>%
    rowwise() %>%
    dplyr::mutate(
      alignment_status_exposures = case_when(
        # Alleles match directly
        ea_exposure_menarche == ea_exposure_bmi &
          nea_exposure_menarche == nea_exposure_bmi ~ "aligned",
        # Alleles are swapped
        ea_exposure_menarche == nea_exposure_bmi &
          nea_exposure_menarche == ea_exposure_bmi ~ "reverse",
        TRUE ~ "mismatch"
      )
    ) %>%
    ungroup()

  # Flip outcome effects where alleles are reversed 
  df <- df %>%
    dplyr::mutate(
      beta_exposure_bmi_harmonised = ifelse(alignment_status_exposures == "reverse", 
                                       -beta_exposure_bmi, 
                                       beta_exposure_bmi)
    )

  return(df)
}

exposures_harmonised_check <- check_exposures_harmonisation(exposures_merged)
exposures_harmonised <- exposures_harmonised_check %>% 
  dplyr::filter(alignment_status_exposures != "mismatch")
```

Merging and harmonising the outcome with the exposures

```{r}
merged2 <- inner_join(exposures_harmonised, outcome_t2d_mr, by = "SNP")
```

```{r}
check_outcome_harmonisation <- function(df) {
  df <- df %>%
    rowwise() %>%
    dplyr::mutate(
      alignment_status_outcome = case_when(
        # Alleles match directly
        ea_exposure_menarche == ea_outcome &
          nea_exposure_menarche == nea_outcome ~ "aligned",
        # Alleles are swapped
        ea_exposure_menarche == nea_outcome &
          nea_exposure_menarche == ea_outcome ~ "reverse",
        TRUE ~ "mismatch"
      )
    ) %>%
    ungroup()

  # Flip outcome effects where alleles are reversed 
  df <- df %>%
    dplyr::mutate(
      beta_outcome_harmonised = ifelse(alignment_status_outcome == "reverse", 
                                       -beta_outcome, 
                                       beta_outcome)
    )

  return(df)
}

harmonised_check <- check_outcome_harmonisation(merged2)
harmonised <- harmonised_check %>% dplyr::filter(alignment_status_outcome != "mismatch")
```

#### Saving/reading harmonised file

```{r}
#write_tsv(harmonised, "data/menarche_bmi_t2d_harmonised.tsv")
```

```{r}
harmonised <- read.delim("data/menarche_bmi_t2d_harmonised.tsv", sep = "\t",
                      stringsAsFactors = FALSE)
```

### MR

MR variables

```{r}
#Assigning variables
bY <- harmonised$beta_outcome_harmonised
bX1 <- harmonised$beta_exposure_menarche
bX2 <- harmonised$beta_exposure_bmi_harmonised
bYse <- harmonised$se_outcome

#Orientation of the genetic associations
bY<-ifelse(bX1>0, bY, bY-1)
bX1<-abs(bX1)

```

#### Multivariate IVW MR

```{r}
theta1MI = summary(lm(bY~bX1+bX2-1, weights=bYse^-2))#$coef[1]
print(theta1MI)

# se_theta1MI.fixed = summary(lm(bY~bX1+bX2-1, weights=bYse^-2))$coef[1,2]/
#   summary(lm(bY~bX1+bX2-1, weights=bYse^-2))$sigma
# 
# se_theta1MI.random = summary(lm(bY~bX1+bX2-1, weights=bYse^-2))$coef[1,2]/
#   min(summary(lm(bY~bX1+bX2-1, weights=bYse^-2))$sigma,1)
# 
# print(theta1MI)
# print(se_theta1MI.fixed)
# print(se_theta1MI.random)
# 
# ci_lower <- theta1MI - 1.96 * se_theta1MI.random
# ci_upper <- theta1MI + 1.96 * se_theta1MI.random
# p_value  <- 2 * (1 - pnorm(abs(theta1MI / se_theta1MI.random)))
# 
# cat("Causal estimate (exposure 1):", round(theta1MI, 4), "\n",
#     "95% CI:", round(ci_lower, 4), "to", round(ci_upper, 4), "\n",
#     "P-value:", signif(p_value, 3))
```

What this means

``` r
# Call:
# lm(formula = bY ~ bX1 + bX2 - 1, weights = bYse^-2)
# 
# Weighted Residuals:
#     Min      1Q  Median      3Q     Max 
# -9.3770 -0.9762  0.0132  0.9435  6.6989 
# 
# Coefficients:
#     Estimate Std. Error t value Pr(>|t|)    
# bX1 -0.03409    0.01900  -1.794   0.0731 .  
# bX2  1.08968    0.05758  18.926   <2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Residual standard error: 1.699 on 801 degrees of freedom
# Multiple R-squared:  0.3945,  Adjusted R-squared:  0.3929 
# F-statistic: 260.9 on 2 and 801 DF,  p-value: < 2.2e-16
```

Funnel plot - multivariable IVW - without lines

```{r}
dat <- harmonised
fit <- lm(harmonised$beta_outcome_harmonised ~ harmonised$beta_exposure_menarche + harmonised$beta_exposure_bmi_harmonised - 1, weights = harmonised$se_outcome^-2)
dat$pred <- predict(fit)
dat$resid <- resid(fit)
dat$precision <- 1 / harmonised$se_outcome

library(ggplot2)

ggplot(dat, aes(x = resid, y = precision)) +
  geom_point() +
  geom_vline(xintercept = 0, color = "red", linetype = "dashed") +
  labs(
    title = "Funnel plot from multivariable IVW MR regression",
    x = "Residuals (bY - predicted bY)",
    y = "Precision (1 / SE of bY)"
  ) +
  theme_minimal()

```

Funnel plot with CI lines

```{r}
#' Multivariable MR funnel plot (two exposures)
#' 
#' @param bY Numeric vector of SNP–outcome associations
#' @param bYse Numeric vector of SNP–outcome standard errors
#' @param bX1 Numeric vector of SNP–exposure1 associations
#' @param bX2 Numeric vector of SNP–exposure2 associations
#' @param fit Optional: lm object from lm(bY ~ bX1 + bX2 - 1, weights=bYse^-2)
#' @param CI Logical; whether to include 95% confidence intervals
#' 
#' @return A ggplot2 funnel plot
#' @examples
#' funnel_mvmr(bY, bYse, bX1, bX2, fit)
funnel_mvmr <- function(bY, bYse, bX1, bX2, fit = NULL, CI = TRUE, title = 'Funnel Plot') {
  library(ggplot2)
  
  # If no fit is provided, run the regression
  if (is.null(fit)) {
    fit <- lm(bY ~ bX1 + bX2 - 1, weights = bYse^-2)
  }
  
  # Predicted and residual values
  pred <- predict(fit)
  resid <- resid(fit)
  
  # Compute "per-SNP causal ratio" equivalent (residuals or partial effects)
  r <- resid   # for multivariable Egger funnel, residuals are more meaningful
  precision <- abs(1 / bYse)
  
  # Compute 95% CI for visual clarity
  CI_lower <- r - qnorm(0.975) * bYse
  CI_upper <- r + qnorm(0.975) * bYse
  
  dframe <- data.frame(r, precision, CI_lower, CI_upper)
  
  X_label <- "Residual (observed - predicted bY)"
  Y_label <- "Precision (1 / SE)"
  
  # Weighted mean line (analogous to IVW estimate)
  ivw_estimate <- sum(bY * (1 / bYse^2)) / sum(1 / bYse^2)
  
  if (CI) {
    p <- ggplot(dframe, aes(x = r, y = precision)) +
      geom_point() +
      geom_linerange(aes(xmin = CI_lower, xmax = CI_upper)) +
      geom_vline(xintercept = 0, color = "black") +
      geom_vline(xintercept = ivw_estimate, lty = 2, color = "red") +
      ylab(Y_label) + xlab(X_label) +
      theme_classic() +
      ggtitle(title)
  } else {
    p <- ggplot(dframe, aes(x = r, y = precision)) +
      geom_point() +
      geom_vline(xintercept = 0, color = "black") +
      geom_vline(xintercept = ivw_estimate, lty = 2, color = "red") +
      ylab(Y_label) + xlab(X_label) +
      theme_classic() +
      ggtitle(title)
  }
  
  print(p)
  invisible(p)
}

```

```{r}
dat <- harmonised
fit <- lm(harmonised$beta_outcome_harmonised ~ harmonised$beta_exposure_menarche + harmonised$beta_exposure_bmi_harmonised - 1, weights = harmonised$se_outcome^-2)
dat$pred <- predict(fit)
dat$resid <- resid(fit)
dat$precision <- 1 / harmonised$se_outcome

funnel_mvmr(bY = harmonised$beta_outcome_harmonised, 
            bYse = harmonised$se_outcome, 
            bX1 = harmonised$beta_exposure_menarche, 
            bX2 = harmonised$beta_exposure_bmi_harmonised, 
            fit = fit, 
            title = 'Multivariable IVW MR Funnel Plot')
```

#### Multivariate MR Eggar code

```{r}
# #Assigning variables
# bY <- harmonised$beta_outcome_harmonised
# bX1 <- harmonised$beta_exposure_menarche
# bX2 <- harmonised$beta_exposure_bmi_harmonised
# bYse <- harmonised$se_outcome
# 
# 
# #Causal estimate for X1
# multivariate_mr_eggar_regression_model <- summary(lm(bY~bX1+bX2, weights=bYse^-2))
# theta1ME = multivariate_mr_eggar_regression_model$coef[2]
# print(multivariate_mr_eggar_regression_model)
# 
# se_theta1ME.random = summary(lm(bY~bX1+bX2, weights=bYse^-2))$coef[2,2]/
#   min(summary(lm(bY~bX1+bX2, weights=bYse^-2))$sigma,1)
# 
# lb_theta1ME = theta1ME - qt(0.975,df=length(bX1)-4)*se_theta1ME.random
# ub_theta1ME = theta1ME + qt(0.975,df=length(bX1)-4)*se_theta1ME.random
# p_theta1ME = 2*(1-pt(abs(theta1ME/se_theta1ME.random),df=length(bX1)-4))
# 
# 
# #Test for directional pleiotropy
# interME = summary(lm(bY~bX1+bX2, weights=bYse^-2))$coef[1]
# se_interME.random = summary(lm(bY~bX1+bX2, weights=bYse^-2))$coef[1,2]/
#   min(summary(lm(bY~bX1+bX2, weights=bYse^-2))$sigma,1)
# p_interME = 2*(1-pt(abs(interME/se_interME.random),df=length(bX1)-4))
```

```{r}
theta1MI = summary(lm(bY~bX1+bX2, weights=bYse^-2))#$coef[1]
print(theta1MI)
```

Explanation of results

``` r
# Call:
# lm(formula = bY ~ bX1 + bX2, weights = bYse^-2)
# 
# Weighted Residuals:
#     Min      1Q  Median      3Q     Max 
# -9.3280 -0.9439  0.0320  0.9794  6.7612 
# 
# Coefficients:
#              Estimate Std. Error t value Pr(>|t|)    
# (Intercept) -0.001689   0.001068  -1.582    0.114    
# bX1          0.020497   0.039388   0.520    0.603    
# bX2          1.084991   0.057599  18.837   <2e-16 ***
# ---
# Signif. codes:  0 ‘***’ 0.001 ‘**’ 0.01 ‘*’ 0.05 ‘.’ 0.1 ‘ ’ 1
# 
# Residual standard error: 1.698 on 800 degrees of freedom
# Multiple R-squared:  0.3132,  Adjusted R-squared:  0.3115 
# F-statistic: 182.4 on 2 and 800 DF,  p-value: < 2.2e-16
```

```{r}
# Funnel plot 
# ------------------------------------------------------------

library(ggplot2)


# SNP-specific MR causal estimate (Wald ratio)
dat$bIV <- dat$beta_outcome_harmonised / dat$beta_exposure_menarche
dat$SE_IV <- sqrt((dat$se_outcome / dat$beta_exposure_menarche)^2)
dat$precision <- 1 / dat$SE_IV

# Compute overall MR estimates (replace with your actual values)
egger_intercept <- -0.001689  # MR-Egger intercept - first row in the above results
ivw_estimate <- sum(dat$bIV / dat$SE_IV^2) / sum(1 / dat$SE_IV^2)  # IVW estimate

# Funnel boundaries (straight oblique lines)
max_prec <- max(dat$precision)
prec_seq <- seq(0, max_prec, length.out = 100)
funnel_df <- data.frame(
  precision = prec_seq,
  left  = ivw_estimate - 1.96 / prec_seq,
  right = ivw_estimate + 1.96 / prec_seq
)

# Funnel plot
ggplot(dat, aes(x = bIV, y = precision)) +
  geom_point(size = 0.7, alpha = 0.1, color = "black") +
  geom_vline(xintercept = egger_intercept, color = "pink", size = 0.8) +
  geom_vline(xintercept = ivw_estimate, color = "green", linetype = "dashed", size = 0.8) +
  geom_line(data = funnel_df, aes(x = left, y = precision), color = "steelblue", linetype = "dotted") +
  geom_line(data = funnel_df, aes(x = right, y = precision), color = "steelblue", linetype = "dotted") +
  labs(
    title = "Funnel plot for MR analysis",
    x = expression("Instrumental variable effect (" * beta[IV] * ")"),
    y = expression("Precision (1 / SE"[IV] * ")")) + #,
    #caption = "The vertical solid gray line represents the MR-Egger intercept;\n
     #          the vertical dashed gray line represents the inverse variance weighted estimate") +
  theme_classic(base_size = 13) +
  theme(
    plot.title = element_text(hjust = 0.5, face = "bold"),
    plot.caption = element_text(size = 10, hjust = 0.5)
  )

```

### The two types of funnel plots - univariate MR

```{r}
dat <- harmonised

univ_ivw <- lm(
  harmonised$beta_outcome_harmonised ~ harmonised$beta_exposure_menarche, # - 1, #+ harmonised$beta_exposure_bmi_harmonised
  weights = harmonised$se_outcome^-2
)
print(univ_ivw)

dat$pred <- predict(univ_ivw)
dat$resid <- resid(univ_ivw)
dat$precision <- 1 / harmonised$se_outcome
dat$variance <- harmonised$se_outcome^2
dat$inv_variance <- 1 / dat$variance
dat$effect <- harmonised$beta_outcome_harmonised
dat$se <- harmonised$se_outcome
dat$se_over_betaexposure <- harmonised$se_outcome / harmonised$beta_exposure_menarche

# IVW 
beta_of_ivw <- univ_ivw$coefficients[2]
print(ivw)
se_of_beta_of_ivw <- summary(univ_ivw)$coefficients[2, 2]
print(se_of_beta_of_ivw)

library(ggplot2)
library(patchwork)

# --- Helper function for funnel bounds ---
funnel_bounds <- function(se, bhat) {
  data.frame(
    se = se,
    upper = bhat + 1.96 * se,
    lower = bhat - 1.96 * se
  )
}

# --- Funnel plot: Standard Error of Outcome /  Beta of Exposure ---
funnel_A <- funnel_bounds(se_of_beta_of_ivw, beta_of_ivw)
print(funnel_A)

pA <- ggplot(dat, aes(x = effect, y = se_over_betaexposure)) +
  geom_point(color = "steelblue", alpha = 0.7) +
  geom_line(data = funnel_A, 
            aes(x = upper, y = se), 
            linetype = "dashed") +
  geom_line(data = funnel_A, 
            aes(x = lower, y = se), 
            linetype = "dashed") +
  geom_vline(xintercept = intercept, color = "red") +
  scale_y_reverse() +
  labs(
    title = "Funnel plot: Standard Error of Outcome / Beta of Exposure",
    x = "SNP beta outcome / SNP beta exposure", 
    y = "Standard error of outcome / beta exposure"
  ) +
  theme_minimal()

# --- Funnel plot: Precision = 1/SE ---
prec_range <- seq(1 / max(dat$se), 1 / min(dat$se), length.out = 200)
se_from_prec <- 1 / prec_range
funnel_B <- data.frame(
  precision = prec_range,
  upper = intercept + 1.96 * se_from_prec,
  lower = intercept - 1.96 * se_from_prec
)

pB <- ggplot(dat, aes(x = effect, y = precision)) +
  geom_point(color = "steelblue", alpha = 0.7) +
  geom_line(data = funnel_B, aes(x = upper, y = precision), linetype = "dashed") +
  geom_line(data = funnel_B, aes(x = lower, y = precision), linetype = "dashed") +
  geom_vline(xintercept = intercept, color = "red") +
  labs(
    title = "Funnel plot: Precision = 1/SE",
    x = "SNP beta outcome / SNP beta exposure", y = "Precision (1/SE)"
  ) +
  theme_minimal()

# --- Combine plots ---
(pA | pB) 

```
